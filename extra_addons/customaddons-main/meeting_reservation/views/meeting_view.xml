<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <!-- CALENDARIO (sin domain; el filtrado hazlo con búsqueda o contexto en la acción si quieres por defecto) -->
  <record id="view_meeting_calendar" model="ir.ui.view">
    <field name="name">meeting.meeting.calendar</field>
    <field name="model">meeting.meeting</field>
    <field name="arch" type="xml">
      <calendar string="Reservas"
              date_start="start_readonly"
              date_stop="stop_readonly"
              mode="month"
              color="color"
              quick_add="False"
              >
            <field name="name"/>
            <field name="start_datetime"/>
            <field name="end_datetime"/>
            <field name="room_id"/>
            <field name="organizer_id"/>
            <field name="state" widget="badge"
                       decoration-info="state=='pending'"
                       decoration-muted="state=='draft'"
                       decoration-danger="state=='rechazado'"
                       decoration-success="state=='aprobado'"
                       />
      </calendar>
    </field>
  </record>

  <!-- LISTA -->
  <record id="view_meeting_tree" model="ir.ui.view">
    <field name="name">meeting.meeting.tree</field>
    <field name="model">meeting.meeting</field>
    <field name="arch" type="xml">
      <tree decoration-muted="state == 'draft'"
            decoration-info="state == 'pending'"
            decoration-success="state == 'approved'"
            decoration-danger="state == 'rejected'">
        <field name="name"/>
        <field name="organizer_id"/>
        <field name="start_datetime"/>
        <field name="end_datetime"/>
        <field name="room_id"/>
        <field name="state"/>
      </tree>
    </field>
  </record>

  <!-- FORMULARIO -->
  <record id="view_meeting_form" model="ir.ui.view">
    <field name="name">meeting.meeting.form</field>
    <field name="model">meeting.meeting</field>
    <field name="arch" type="xml">
      <form string="Reserva de Reunión">
        <header>
          <button string="Enviar"   type="object" name="action_to_pending" states="draft" class="btn-primary"/>
          <button string="Aprobar" type="object" name="action_approve"
                  class="btn-primary"
                  attrs="{'invisible':['|',('state','!=','pending'),('is_room_responsible','=',False)]}"/>

          <button string="Rechazar" type="object" name="action_reject"
                  class="btn-primary"
                  attrs="{'invisible':['|',('state','!=','pending'),('is_room_responsible','=',False)]}"/>
          <button string="Revertir a Borrador" type="object" name="action_reset_draft" states="pending"/>
          <field name="state" widget="statusbar" statusbar_visible="draft,pending,approved,rejected"/>
        </header>

        <sheet>
          <!-- >>> Campo oculto requerido por attrs para ocultar el bloque de usuario si es admin <<< -->
          <field name="is_user" invisible="1"/>
          <field name="is_room_responsible" invisible="1"/>
          <notebook>

            <page string="Detalles de la reunión">
              <group col="12" attrs="{'readonly': [('state', 'in', ['pending','approved','rejected'])]}">

                <!-- Asunto (más grande) -->
                <group  colspan="12">
                  <field name="name" class="o_form_label_bigger"/>
                </group>
                  <!-- Columna izquierda: tiempos -->
                  <group colspan="6">
                    <field name="start_datetime"/>
                    <field name="duration_hours_user"
                    attrs="{'readonly': [('state', 'in', ['pending','approved','rejected'])]}"/>
                    <!-- Duración admin -->
                    <field name="duration_hours_admin" attrs="{'readonly': [('state', 'in', ['pending','approved','rejected'])]}"/>
                    <field name="end_datetime" readonly="1"/>
                  </group>

                  <!-- Columna derecha: termina, organizador, sala, URL -->
                  <group colspan="6">
                    <field name="organizer_id"/>
                    <field name="room_id"
                           options="{'no_create': True, 'no_create_edit': True, 'no_quick_create': True}"/>
                    <field name="video_url"/>
                  </group>

                <!-- Descripción grande -->
                <group colspan="12">
                  <field name="description"/>
                </group>

              </group>
            </page>



            <page string="Invitaciones">
              <field name="invitation_ids">
                <tree editable="bottom">
                  <field name="employee_id"/>
                  <field name="department"/>
                  <field name="state" attrs="{'readonly':[('is_my_invitation','=',False)]}"/>
                  <field name="is_my_invitation" invisible="1"/>
                </tree>
              </field>
              <button name="action_send_all_invitations"
                      string="Enviar a todos" type="object"
                      class="btn-secondary"/>
            </page>

            <!-- Opciones (recurrencia) solo admin -->
            <page string="Opciones" groups="meeting_reservation.group_meeting_admin">
              <group>
                <field name="recurrency"/>
              </group>
              <div attrs="{'invisible': [('recurrency','=',False)]}">
                <group>
                  <label for="interval"/>
                  <div class="o_col">
                    <div class="o_row">
                      <field name="interval" class="oe_inline"
                             attrs="{'required': [('recurrency', '=', True)]}"/>
                      <field name="rrule_type"
                             attrs="{'required': [('recurrency', '=', True)]}"/>
                    </div>
                    <widget name="week_days" attrs="{'invisible': [('rrule_type', '!=', 'weekly')]}"/>
                  </div>

                  <!-- Renombrado 'Hasta' y sin opción 'Siempre' -->
                  <label string="Hasta" for="end_type"/>
                  <div class="o_row">
                    <field name="end_type" attrs="{'required': [('recurrency', '=', True)]}"/>
                    <field name="count"
                           attrs="{'invisible': [('end_type', '!=', 'count')],
                                   'required':  [('end_type','=','count'), ('recurrency','=',True)]}"/>
                    <field name="until"
                           attrs="{'invisible': [('end_type', '!=', 'end_date')],
                                   'required':  [('end_type','=','end_date'), ('recurrency','=',True)]}"/>
                  </div>
                </group>

                <group attrs="{'invisible': [('rrule_type', '!=', 'monthly')]}">
                  <label string="Día del mes" for="month_by"/>
                  <div class="o_row">
                    <field name="month_by"/>
                    <field name="day"
                           attrs="{'required': [('month_by','=','date'), ('rrule_type','=','monthly')],
                                   'invisible': [('month_by','!=','date')]}"/>
                    <field name="byday" string="El"
                           attrs="{'required': [('recurrency','=',True), ('month_by','=','day'), ('rrule_type','=','monthly')],
                                   'invisible': [('month_by','!=','day')]}"/>
                    <field name="weekday" nolabel="1"
                           attrs="{'required': [('recurrency','=',True), ('month_by','=','day'), ('rrule_type','=','monthly')],
                                   'invisible': [('month_by','!=','day')]}"/>
                  </div>
                </group>
              </div>
            </page>

          </notebook>
        </sheet>

        <div class="oe_chatter">
          <field name="message_follower_ids"/>
          <field name="activity_ids"/>
          <field name="message_ids"/>
        </div>
      </form>
    </field>
  </record>

  <!-- BÚSQUEDA (si quieres abrir por defecto con aprobadas, puedes usar esta vista + contexto en acción) -->
  <record id="view_meeting_search" model="ir.ui.view">
    <field name="name">meeting.meeting.search</field>
    <field name="model">meeting.meeting</field>
    <field name="arch" type="xml">
      <search>
        <filter string="Aprobadas" name="approved" domain="[('state','=','approved')]"/>
        <field name="name"/>
        <field name="room_id"/>
        <field name="organizer_id"/>
        <field name="state"/>
      </search>
    </field>
  </record>

  <!-- ACCIÓN principal (sin domain en calendar; puedes activar el filtro por defecto con search_default_approved) -->
  <record id="action_meeting_meeting" model="ir.actions.act_window">
    <field name="name">Reservas</field>
    <field name="res_model">meeting.meeting</field>
    <field name="view_mode">calendar,tree,form</field>
    <!-- Si quieres abrir el calendario solo con Aprobadas, descomenta la línea de abajo -->
    <!-- <field name="context">{'calendar_default_view': 'month', 'search_default_approved': 1}</field> -->
    <field name="context">{'calendar_default_view': 'month'}</field>
  </record>
</odoo>
