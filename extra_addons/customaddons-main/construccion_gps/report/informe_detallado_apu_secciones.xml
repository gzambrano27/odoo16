<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Paper Format -->
        <record id="report_apu_format_breakdown" model="report.paperformat">
            <field name="name">Formato APU Reporte</field>
            <field name="default" eval="True"/>
            <field name="format">A4</field>
            <field name="orientation">Portrait</field>
            <field name="margin_top">7</field>
            <field name="margin_bottom">5</field>
            <field name="margin_left">5</field>
            <field name="margin_right">5</field>
            <field name="header_line" eval="False"/>
            <field name="header_spacing">10</field>
        </record>

        <!-- Report Definition -->
        <record id="report_apu_breakdown_action" model="ir.actions.report">
            <field name="name">Reporte Detallado APU – Secciones Consolidadas</field>
            <field name="model">apu.apu</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">construccion_gps.report_apu_breakdown_template</field>
            <field name="report_file">construccion_gps.report_apu_breakdown_template</field>
            <field name="binding_model_id" ref="construccion_gps.model_apu_apu"/>
            <field name="binding_type">report</field>
            <field name="paperformat_id" ref="report_apu_format_breakdown"/>
            <field name="print_report_name">"Reporte Consolidado APU - " + object.code</field>
        </record>

        <!-- QWeb Template for APU Breakdown Report -->
        <template id="report_apu_breakdown_template">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-call="web.basic_layout">
                        <div class="page" style="font-family:verdana; font-size:16px;">

                            <!-- Header -->
                            <div class="row align-items-center mb-2">
                                <div class="col-6">
                                    <img t-if="doc.company_id.logo"
                                         t-att-src="image_data_uri(doc.company_id.logo)"
                                         style="max-height:125px; max-width:125%;"/>
                                </div>
                                <div class="col-6 text-end">
                                    <h2 style="margin:0; font-weight:bold;">
                                        APU # <span t-field="doc.code"/>
                                    </h2>
                                </div>
                            </div>

                            <!-- APU Info -->
                            <div class="row mb-4">
                                <div class="col-6">
                                    <p style="margin:0;">
                                        <strong>Producto:</strong>
                                        [<span t-field="doc.product_tmpl_id.default_code"/>]
                                        <span t-field="doc.product_tmpl_id.name"/>
                                    </p>
                                </div>
                                <div class="col-6 text-end">
                                    <p style="margin:0;">
                                        <strong>Unidad:</strong> <span t-field="doc.product_uom_id.name"/>
                                    </p>
                                    <p style="margin:0;">
                                        <strong>Total Precio:</strong>
                                        <span t-field="doc.total_apu_precio"
                                              t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                    </p>
                                </div>
                            </div>

                            <!-- Prepare collections -->
                            <t t-set="lines" t-value="doc.line_ids"/>
                            <t t-set="labels" t-value="{
                                'equipo':'Equipos','manoobra':'Mano de Obra',
                                'material':'Materiales','transporte':'Transporte'
                            }"/>

                            <!-- Build (line,task) pairs for manoobra -->
                            <t t-set="task_pairs" t-value="[
                                (l, t)
                                for l in lines
                                if l.tipo_componente == 'manoobra'
                                for t in l.line_tarea_ids
                            ]"/>

                            <!-- Grand total -->
                            <t t-set="grand_total" t-value="
                                sum(l.precio_general for l in lines.filtered(lambda l: l.tipo_componente != 'manoobra'))
                                + sum(lp[0].product_qty * lp[1].cantidad * lp[1].costo * lp[1].rendimiento for lp in task_pairs)
                            "/>

                            <!-- Consolidated Sections -->
                            <t t-foreach="['equipo','manoobra','material','transporte']" t-as="type">
                                <t t-set="sec_lines" t-value="lines.filtered(lambda l: l.tipo_componente == type and l.tipo_componente != 'manoobra')"/>
                                <t t-set="sec_tasks" t-value="[lp for lp in task_pairs if lp[1].tipo_actividad == type]"/>
                                <t t-set="sec_total" t-value="
                                    sum(l.precio_general for l in sec_lines)
                                    + sum(lp[0].product_qty * lp[1].cantidad * lp[1].costo * lp[1].rendimiento for lp in sec_tasks)
                                "/>

                                <div style="page-break-inside: avoid; margin-bottom:8px;">
                                    <t t-if="sec_lines or sec_tasks">
                                        <h3 style="margin-top:20px; border-bottom:1px solid #000; padding-bottom:4px;">
                                            <t t-esc="labels[type]"/>
                                        </h3>
                                    </t>

                                    <!-- Styled table for lines -->
                                    <t t-if="sec_lines">
                                        <table class="table table-sm"
                                               style="border:1px solid #ccc; border-collapse:collapse; width:100%; margin-bottom:20px;">
                                            <thead>
                                                <tr style="background-color:#EAECEE;">
                                                    <th style="width:14%; text-align:center">CODIGO</th>
                                                    <th style="width:27%; text-align:center">DESCRIPCIÓN</th>
                                                    <th style="width:13%; text-align:center">U</th>
                                                    <th style="width:10%; text-align:center">CANT</th>
                                                    <th style="width:25%; text-align:center">P.UNIT</th>
                                                    <th style="width:11%; text-align:right">TOTAL</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="sec_lines" t-as="line">
                                                    <tr>
                                                        <td style="text-align:center" class="text-center">
                                                            <t t-esc="line.product_id.product_tmpl_id.default_code"/>
                                                        </td>
                                                        <td style="text-align:left"><t t-esc="line.product_id.name"/></td>
                                                        <td style="text-align:center" class="text-center"><t t-esc="line.product_uom_id.name"/></td>
                                                        <td style="text-align:center" class="text-center">
                                                            <t t-esc="line.product_qty"
                                                               t-options='{"widget":"float","precision":2}'/>
                                                        </td>
                                                        <td style="text-align:center" class="text-end">
                                                            <span t-esc="line.precio_unit"
                                                                  t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                        </td>
                                                        <td style="text-align:right" class="text-end">
                                                            <span t-esc="line.precio_general"
                                                                  t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>

                                    <!-- Styled table for tasks -->
                                    <t t-if="sec_tasks">
                                        <table class="table table-sm"
                                               style="border:1px solid #ccc; border-collapse:collapse; width:100%; margin-bottom:20px;">
                                            <thead>
                                                <tr style="background-color:#EAECEE;">
                                                    <th style="width:14%; text-align:center">CODIGO</th>
                                                    <th style="width:27%; text-align:center">DESCRIPCIÓN</th>
                                                    <th style="width:14%; text-align:center">U</th>
                                                    <th style="width:10%; text-align:center">CANT</th>
                                                    <th style="width:8%; text-align:center">C/H</th>
                                                    <th style="width:8%; text-align:center">C.HORA</th>
                                                    <th style="width:8%; text-align:center">REND.</th>
                                                    <th style="width:11%; text-align:right">TOTAL</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="sec_tasks" t-as="lp">
                                                    <t t-set="l" t-value="lp[0]"/>
                                                    <t t-set="task" t-value="lp[1]"/>
                                                    <tr>
                                                        <td style="text-align:center" class="text-center">
                                                            <t t-esc="task.tarea_id.product_tmpl_id.default_code"/>
                                                        </td>
                                                        <td style="text-align:left"><t t-esc="task.tarea_id.name"/></td>
                                                        <td class="text-center"><t t-esc="task.unidad.name"/></td>
                                                        <!-- Ahora sí usamos l.product_qty -->
                                                        <td style="text-align:center" class="text-center">
                                                            <t t-esc="l.product_qty * task.cantidad"
                                                               t-options='{"widget":"float","precision":2}'/>
                                                        </td>
                                                        <td style="text-align:center" class="text-end">
                                                            <span t-esc="task.costo"
                                                                  t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                        </td>
                                                        <td style="text-align:center" class="text-end">
                                                            <span t-esc="l.product_qty * task.cantidad * task.costo"
                                                                  t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                        </td>
                                                        <td style="text-align:center" class="text-center"><t t-esc="task.rendimiento"/></td>
                                                        <td style="text-align:right" class="text-end">
                                                            <span t-esc="l.product_qty * task.cantidad * task.costo * task.rendimiento"
                                                                  t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </t>

                                    <t t-if="sec_lines or sec_tasks">
                                        <div style="text-align:right; margin:4px 0;">
                                            <strong>Subtotal <t t-esc="labels[type]"/>:</strong>
                                            <span t-esc="sec_total"
                                                  t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                        </div>
                                    </t>
                                </div>
                            </t>

                            <!-- Totals at the end, using clearfix pattern -->
                            <div class="clearfix" name="apu_total_summary">
                                <div class="row" name="total">
                                    <div class="col-6 ms-auto">
                                        <table class="table table-sm table-borderless">
                                            <tbody>
                                                <tr>
                                                    <td><strong>Total secciones:</strong></td>
                                                    <td style="text-align:right;" class="text-end">
                                                        <span t-esc="grand_total"
                                                              t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Indirectos
                                                        <span t-esc="doc.indirectos_porcentaje or 0"/>%:
                                                    </td>
                                                    <td style="text-align:right;" class="text-end">
                                                        <span t-esc="doc.indirectos_precio"
                                                              t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Utilidad
                                                        <span t-esc="doc.utilidad_porcentaje or 0"/>%:
                                                    </td>
                                                    <td style="text-align:right;" class="text-end">
                                                        <span t-esc="doc.utilidad_precio"
                                                              t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                    </td>
                                                </tr>
                                                <t t-set="total_general" t-value="grand_total + doc.indirectos_precio + doc.utilidad_precio"/>
                                                <tr style="border-top:1px solid #ccc;">
                                                    <td><strong>Total General APU:</strong></td>
                                                    <td style="text-align:right;" class="text-end">
                                                        <strong>
                                                            <span t-esc="total_general"
                                                                  t-options='{"widget":"monetary","display_currency":doc.company_id.currency_id}'/>
                                                        </strong>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </t>
                </t>
            </t>
        </template>

    </data>
</odoo>
