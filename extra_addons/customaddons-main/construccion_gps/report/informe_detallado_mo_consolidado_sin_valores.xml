<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- Paper Format (sin valores) -->
    <record id="report_docs_format_inform_mo_consolida_sin_valores" model="report.paperformat">
      <field name="name">Formato Informe MO Consolidado (Sin Valores)</field>
      <field name="format">A4</field>
      <field name="orientation">Portrait</field>
      <field name="margin_top">7</field>
      <field name="margin_bottom">5</field>
      <field name="margin_left">5</field>
      <field name="margin_right">5</field>
      <field name="header_line" eval="False"/>
      <field name="header_spacing">10</field>
    </record>

    <!-- Acción de Reporte (sin valores) -->
    <record id="report_inform_mo_consolida_sin_valores" model="ir.actions.report">
      <field name="name">Informe Mano de Obra Consolidado (Sin Valores)</field>
      <field name="model">sale.order</field>
      <field name="report_type">qweb-pdf</field>
      <field name="report_name">construccion_gps.informe_detallado_mo_consolida_sin_valores</field>
      <field name="report_file">construccion_gps.informe_detallado_mo_consolida_sin_valores</field>
      <field name="binding_model_id" ref="sale.model_sale_order"/>
      <field name="binding_type">report</field>
      <field name="paperformat_id" ref="report_docs_format_inform_mo_consolida_sin_valores"/>
      <field name="print_report_name">"Mano de Obra Consolidado (Sin Valores) - " + object.name</field>
    </record>

    <!-- Template QWeb (sin valores) -->
    <template id="informe_detallado_mo_consolida_sin_valores">
      <t t-call="web.html_container">
        <t t-foreach="docs" t-as="doc">
          <t t-call="web.basic_layout">
            <div class="page" style="font-family:Verdana, sans-serif; font-size:15px;">

              <!-- Cabecera -->
              <div class="row align-items-center mb-2">
                <div class="col-2">
                  <img t-if="doc.company_id.logo"
                       t-att-src="image_data_uri(doc.company_id.logo)"
                       style="max-height:125px; max-width:125%;"/>
                </div>
                <div style="font-size:12px;" class="col-6">
                  <p style="margin:0px;"><span t-field="doc.company_id.name"/></p>
                  <p style="margin:0px;">RUC: <span t-field="doc.company_id.vat"/></p>
                  <p style="margin:0px;">KM 1.5 DE LA AV. SAMBORONDON</p>
                  <p style="margin:0px;">EDIFICIO OFFICE CENTER OFICINA 26 PISO 3</p>
                  <p style="margin:0px;">SAMBORONDON, ECUADOR</p>
                  <p style="margin:0px;">TEL: (593)42097912 - 0983380657</p>
                  <p style="margin:0px;">EMAIL: gpsgroup@gpsgroup.com.ec</p>
                </div>
                <div class="col-4">
                  <h5 style="margin:0; font-weight:bold;">Mano de Obra – Consolidado</h5>
                  <p><span t-field="doc.referencia_analitica"/></p>
                </div>
              </div>
              <div class="row mb-4">
                <div>
                  <strong>PROYECTO: </strong><span t-field="doc.proyecto"/><br/>
                  <strong>CLIENTE: </strong><span t-field="doc.partner_id"/><br/>
                  <strong>REVISIÓN No.: </strong>A<br/>
				  <!-- Definimos la variable hoy -->
				  <t t-set="today" t-value="datetime.date.today()"/>
                  <strong>FECHA: </strong><span t-esc="today.strftime('%d/%m/%Y')"/>
                </div>
              </div>

              <!-- Preparación de datos (misma lógica, solo no se muestran valores) -->
              <t t-set="sale_lines" t-value="doc._get_order_lines_to_report()"/>
              <t t-set="apu_pairs" t-value="[
                  (l, doc.env['apu.apu'].search([('id','=', l.apu_id.id)], limit=1))
                  for l in sale_lines
              ]"/>
              <t t-set="filtered" t-value="[
                  (l,a) for (l,a) in apu_pairs
                  if a and a.subcategoria_id
                     and a.line_ids.filtered(lambda r: r.tipo_componente=='manoobra')
              ]"/>
              <t t-set="apus" t-value="doc.env['apu.apu'].browse([a.id for (_,a) in filtered])"/>
              <t t-set="categories" t-value="apus.mapped('subcategoria_id.categoria_id').sorted('codigo')"/>
              <t t-set="counter" t-value="0"/>

              <!-- Tabla Consolidada (sin columnas de valores) -->
              <table class="table table-sm o_main_table"
                     style="border:1px solid #ccc; border-collapse:collapse; width:100%; page-break-inside:avoid;">
                <thead>
                  <tr style="background-color:#EAECEE;">
                    <th style="padding:8px; border:1px solid #ccc; width:6%;">N°</th>
                    <th style="padding:8px; border:1px solid #ccc; width:16%;">ITEM</th>
                    <th style="padding:8px; border:1px solid #ccc; width:48%;">DESCRIPCIÓN</th>
                    <th style="padding:8px; border:1px solid #ccc; width:15%;">UNIDAD</th>
                    <th style="padding:8px; border:1px solid #ccc; width:15%;">CANTIDAD</th>
                  </tr>
                </thead>
                <tbody>

                  <!-- Agrupación por Categoría (sin subtotales monetarios) -->
                  <t t-foreach="categories" t-as="cat">
                    <tr style="background-color:#DCE6F1;">
                      <td style="padding:8px; border:1px solid #ccc;"></td>
                      <td style="padding:8px; text-align:center; border:1px solid #ccc;">
                        <strong><span t-esc="cat.codigo"/></strong>
                      </td>
                      <td colspan="3" style="padding:8px; border:1px solid #ccc;">
                        <strong><span t-esc="cat.name"/></strong>
                      </td>
                    </tr>

                    <!-- Agrupación por Subcategoría (sin subtotales monetarios) -->
                    <t t-set="subcats" t-value="sorted(
                        { pair[1].subcategoria_id.id: pair[1].subcategoria_id
                          for pair in filtered
                          if pair[1].subcategoria_id.categoria_id.id == cat.id
                        }.values(),
                        key=lambda s: s.codigo
                    )"/>
                    <t t-foreach="subcats" t-as="subcat">
                      <tr style="background-color:#EBF5FB;">
                        <td style="padding:8px; border:1px solid #ccc;"></td>
                        <td style="padding:8px; text-align:center; border:1px solid #ccc;">
                          <strong><span t-esc="subcat.codigo"/></strong>
                        </td>
                        <td colspan="3" style="padding:8px; border:1px solid #ccc;">
                          <strong><span t-esc="subcat.name"/></strong>
                        </td>
                      </tr>

                      <!-- Detalle de líneas (sin costo/precio/subtotales) -->
                      <t t-set="mo_lines" t-value="
                          sum(
                              [a.line_ids.filtered(lambda r: r.tipo_componente=='manoobra')
                               for (_,a) in filtered if a.subcategoria_id.id == subcat.id],
                              doc.env['apu.apu.line']
                          )
                      "/>
                      <t t-foreach="mo_lines.mapped('product_id').sorted(key=lambda p: p.default_code or '')" t-as="prod">
                        <t t-set="qty" t-value="
                            sum(
                                l.product_uom_qty * mo.product_qty
                                for (l,a) in filtered if a.subcategoria_id.id == subcat.id
                                for mo in a.line_ids.filtered(lambda r: r.tipo_componente=='manoobra' and r.product_id.id == prod.id)
                            )
                        "/>
                        <t t-set="mo_ref" t-value="mo_lines.filtered(lambda m: m.product_id.id == prod.id)[0]"/>

                        <!-- Incrementar contador -->
                        <t t-set="counter" t-value="(counter or 0) + 1"/>

                        <tr style="background-color:#ffffff;">
                          <td style="padding:8px; text-align:center; border:1px solid #ccc;">
                            <t t-esc="counter"/>
                          </td>
                          <td style="padding:8px; text-align:center; border:1px solid #ccc;">
                            [<span t-esc="prod.default_code"/>]
                          </td>
                          <td style="padding:8px; text-align:left; border:1px solid #ccc;">
                            <span t-esc="prod.name"/>
                          </td>
                          <td style="padding:8px; text-align:center; border:1px solid #ccc;">
                            <span t-esc="mo_ref.product_uom_id.name"/>
                          </td>
                          <td style="padding:8px; text-align:center; border:1px solid #ccc;">
                            <t t-esc="qty"/>
                          </td>
                        </tr>
                      </t>
                    </t>
                  </t>
                </tbody>

                <!-- Sin Total General (se omite pie de tabla) -->
              </table>

            </div>
          </t>
        </t>
      </t>
    </template>

  </data>
</odoo>
