<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- account.account form inherit view -->
    <record id="view_account_account_form_inherit" model="ir.ui.view">
        <field name="name">account.account.view.form.inherit</field>
        <field name="model">account.account</field>
        <field name="inherit_id" ref="account.view_account_form" />
        <field name="arch" type="xml">
            <xpath expr="//field[@name='currency_id']" position="after">
                <field name="prepayment_account"/>
            </xpath>
        </field>
    </record>

    <!-- account.account search inherit view -->
    <record id="view_account_account_search_inherit" model="ir.ui.view">
        <field name="name">account.account.view.searc.inherit</field>
        <field name="model">account.account</field>
        <field name="inherit_id" ref="account.view_account_search" />
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='expensesacc']" position="after">
                <filter string="Prepayment" name="advancesacc" domain="[('prepayment_account','=', True)]"/>
            </xpath>
        </field>
    </record>

    <!-- account.payment search inherit view -->
    <record id="view_account_payment_search_inherit" model="ir.ui.view">
        <field name="name">account.payment.view.search.inherit</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_search" />
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='transfers_filter']" position="after" >
                <filter string="Prepayments" name="prepayment_filter" domain="[('is_prepayment','=',True)]"/>
                <filter string="Prepayments with balance" name="prepayment_pending_filter" domain="[('is_prepayment','=',True), ('amount_residual', '>', 0)]"/>
            </xpath>
        </field>
    </record>

    <!-- account.payment form inherit view -->
    <record id="view_account_payment_form_inherit" model="ir.ui.view">
        <field name="name">account.payment.view.form.inherit</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_form" />
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_bank_id']" position="before">
                <field name="is_prepayment" attrs="{'invisible': ['|', ('batch_payment', '=', True), ('is_internal_transfer', '=', True)]}" />
                <field name="prepayment_account_id"
                       options='{"no_create_edit": True, "no_open": True, "no_quick_create": True}'
                       attrs="{'invisible': [('is_prepayment', '!=', True)], 'required': [('is_prepayment', '=', True)], }" />
                <field name="available_invoices" invisible="1" />
                <field name="batch_payment" attrs="{'invisible': ['|', ('is_prepayment', '=', True), ('is_internal_transfer', '=', True)]}"/>
            </xpath>
            <xpath expr="//sheet" position="inside">
                <notebook attrs="{'invisible': [('batch_payment', '=', False)]}">
                    <page string="Invoice/Bills">
                        <field name="reconcile_invoice_ids">
                            <tree editable="bottom" no_open="1" >
                                <field name="available_invoices" invisible="1" />
                                <field name="invoice_id" domain="available_invoices" string="Number" required="1"
                                       options="{'limit': 10, 'create': false, 'create_edit': false, 'search_more': true, 'no_open': true}" />
                                <field name="amount_untaxed" readonly="1" force_save="1"/>
                                <field name="amount_tax" readonly="1" force_save="1"/>
                                <field name="amount_total" readonly="1" force_save="1"/>
                                <field name="already_paid" readonly="1" force_save="1"/>
                                <field name="amount_residual" readonly="1" force_save="1"/>
                                <field name="amount_paid" sum="total" />
                            </tree>
                        </field>
                    </page>
                </notebook>
            </xpath>
        </field>
    </record>

    <!-- account.move form inherit view -->
    <record id="view_account_move_form_inherit" model="ir.ui.view">
        <field name="name">account.move.view.form.inherit</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form" />
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_register_payment']" position="after">
                <field name="has_prepayment" invisible="1" />
                <button name="button_prepayment_assign"
                        type="object"
                        string="Assign prepayment"
                        class="btn-primary"
                        attrs="{'invisible': [('has_prepayment', '=', False)]}"/>
            </xpath>
        </field>
    </record>

</odoo>
