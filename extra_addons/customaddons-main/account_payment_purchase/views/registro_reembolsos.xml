<?xml version="1.0" encoding="UTF-8"?>
<odoo>
	<data noupdate="1">
        <!-- Secuencia para el tipo de orden de producción A -->
        <record id="seq_reg_reembolso" model="ir.sequence">
            <field name="name">Registro Reembolsos</field>
            <field name="code">REG_REEM</field>
            <field name="prefix">REEM_</field>
            <field name="padding">5</field>
            <field name="company_id" eval="False"/>
        </record>
    </data>
	<record id="reembolso_user_rule" model="ir.rule">
        <field name="name">Registro de Reembolsos: Solo propios</field>
        <field name="model_id" ref="model_hr_registro_reembolsos"/>
        <field name="groups" eval="[(4, ref('base.group_user'))]"/> <!-- Grupo de usuarios regulares -->
<!--         <field name="domain_force">[('user_id', '=', user.id)]</field> Solo ver registros donde el campo user_id coincide con el usuario conectado -->
        <field name="domain_force">['|', ('user_id', '=', user.id), ('employee_id.parent_id.user_id', '=', user.id)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>
    <record id="reembolso_contador_rule" model="ir.rule">
        <field name="name">Regla de Reembolsos: Acceso total para contadores de reembolsos</field>
        <field name="model_id" ref="model_hr_registro_reembolsos"/>
        <field name="groups" eval="[(4, ref('account_payment_purchase.group_reembolso_contador'))]"/> <!-- Grupo de administradores de reembolsos -->
        <field name="domain_force">[(1, '=', 1)]</field> <!-- Sin restricción, acceso total -->
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>
    <!-- Regla para permitir acceso total al administrador -->
    <record id="reembolso_admin_rule" model="ir.rule">
        <field name="name">Regla de Reembolsos: Acceso total para administradores de reembolsos</field>
        <field name="model_id" ref="model_hr_registro_reembolsos"/>
        <field name="groups" eval="[(4, ref('account_payment_purchase.group_reembolso_manager'))]"/> <!-- Grupo de administradores de reembolsos -->
        <field name="domain_force">[(1, '=', 1)]</field> <!-- Sin restricción, acceso total -->
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Tree view for Registro de Reembolsos -->
    <record model="ir.ui.view" id="view_reg_reembolso_tree">
        <field name="name">hr.registro.reembolsos.tree</field>
        <field name="model">hr.registro.reembolsos</field>
        <field name="arch" type="xml">
            <tree decoration-info="state == 'draft'" decoration-muted="state == 'cancel'" string="Reembolso Entries">
                <field name="name" />
                <field name="employee_id"/>
                <field name="partner_id"/>
                <field name="fecharegistro"/>
                <field name="company_id" />
                <field name="total"/>
                <field name="state" />
            </tree>
        </field>
    </record>

    <!-- Search view for Registro de Reembolsos -->
    <record id="view_reg_reembolso_filter" model="ir.ui.view">
        <field name="name">hr.registro.reembolsos.select</field>
        <field name="model">hr.registro.reembolsos</field>
        <field name="arch" type="xml">
            <search string="Search Reembolsos">
                <field name="employee_id" filter_domain="[('employee_id', 'child_of', self)]"/>
                <field name="name"/>
                <filter name="unpaid" string="No pagados" domain="[('state','in',('draft','approve'))]"/>
                <filter name="paid" string="Pagados" domain="[('state','=','paid')]"/>
                <filter string="Mis reembolsos" name="mis_reembolsos" domain="[('user_id', '=', uid)]"/>
                <filter string="Archivados" name="empleados_archivados" domain="[('employee_id.active','=',False)]"/>
                <filter name="registros_empleados" string="Reembolsos de mis colaboradores" domain="[('employee_id.parent_id.user_id', '=', uid)]"/>
                <group expand="0" string="Group By">
                    <filter name = 'Empleado' string="Empleado" domain="[]" context="{'group_by':'employee_id'}"/>
                    <filter name = 'Estado' string="Estado" domain="[]" context="{'group_by':'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action for Pago de Reembolsos -->
<!--     <act_window id="act_payment_reembolso_wizard" -->
<!--         name="Pago de Reembolso" -->
<!--         src_model="hr.registro.reembolsos" -->
<!--         res_model="payment.reembolso.wizard" -->
<!--         view_mode="form" -->
<!--         target="new" -->
<!--         multi="False" /> -->

    <!-- Form view for Registro de Reembolsos -->
    <record model="ir.ui.view" id="view_registro_reembolsos_form">
        <field name="name">hr.registro.reembolsos.form</field>
        <field name="model">hr.registro.reembolsos</field>
        <field name="arch" type="xml">
            <form string="Registro de Reembolsos">
                <header>
                    <button name="button_revisado" states="draft" string="Revisado" type="object" class="oe_highlight" confirm="¿Estás seguro de confirmar este registro?"/>
                    <button name="button_to_approve" states="revisado" groups="account_payment_purchase.group_reembolso_contador, account_payment_purchase.group_reembolso_manager , base.group_no_one" string="Pendiente Aprobar" type="object" class="oe_highlight" />
                    <button name="button_approve" states="to_approve" groups="account_payment_purchase.group_reembolso_manager, base.group_no_one" string="Approve" type="object" class="oe_highlight" confirm="¿Estás seguro de aprobar este registro?"/>
                    <!-- <button name="obtiene_combustibles" states="draft" string="Obtiene Rubros" class="oe_highlight" type="object" /> -->
                    <!-- <button name="procesa_combustibles" attrs="{'invisible':[('tiene_combustible','!=',True)]}" states="approve" string="Procesa Combustible" class="oe_highlight" type="object" /> -->
                    <button name="button_canceled" states="revisado,to_approve,approve" string="Cancel" class="oe_highlight" type="object" />
                    <button name="button_set_draft" string="Set to Draft" states="cancel" type="object" />
                    <button name="action_print_pdf" string="Imprimir Reembolso" type="object" class="btn-primary"/>
                    <button name="crear_liquidacion_compra" states="approve" string="Genera Liq Compra" type="object" class="btn-primary"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,revisado,to_approve,approve" statusbar_colors='{"draft":"blue"}'/>
                </header>
                <field name="has_outstanding" invisible="1"/>
                <sheet string="Registro de Reembolsos">
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" name="button_payments_reembolso"
                                string="Pagos" type="object"
                                attrs="{'invisible':[('has_pagos','=',False)]}" icon="fa-bars"/>
                    </div>
                    
                    <h3>
                        <field name="name" readonly="1" attrs="{'invisible': [('state','=','draft')]}" />
                        <field name="tiene_combustible" invisible="1"/>
                    </h3>
                    
                    <group>
                        <group>
                            <field name="es_empleado" attrs="{'readonly': [('state','!=','draft')]}"/>
                            <field name="partner_id" attrs="{'required':[('es_empleado','=',False)], 'invisible':[('es_empleado','=', True)]}"/>
                            <field name="employee_id" attrs="{'required':[('es_empleado','=',True)], 'invisible':[('es_empleado','=', False)]}" options='{"always_reload": True, "no_quick_create": True, "no_create_edit": True}' />
                          <field name="job_id" options='{"no_open": True, "no_quick_create": True, "no_create_edit": True}' readonly="1"
                          attrs="{'readonly': [('state','!=','draft')],  'invisible':[('es_empleado','!=', True)]}"
                          />
                            <field name="jefe_id" options='{"always_reload": True, "no_quick_create": True, "no_create_edit": True}'/>
                            <field name="fecharegistro" invisible="1" readonly="1"/>
                            <field name="fecha_revisado" readonly="1" groups="account_payment_purchase.group_reembolso_contador, account_payment_purchase.group_reembolso_manager , base.group_no_one"/>
                            <field name="fechaingreso" required="1" attrs="{'readonly': [('state','!=','draft')]}" />
                            <field name="has_pagos" invisible="1"/>
                            <field name="total_pagos_ant" />
                        </group>
                    </group>
                    <notebook>
                        <page string="Detalle de Reembolsos" >
                            <field name="line_ids" attrs="{'readonly': [('state','in',('approve','paid'))]}">
                                <tree string="Reembolsos Lines" editable="bottom">
                                    <field name="tipo" required="True" options='{"always_reload": True, "no_quick_create": True, "no_create_edit": True}'/>
                                    <field name="name_tipo" invisible="1"/>
                                    <field name="cuenta_analitica_id" required="True" options='{"always_reload": True, "no_quick_create": True, "no_create_edit": True}'/>
                                    <field name="vehicle_id" invisible="1" options='{"always_reload": True, "no_quick_create": True, "no_create_edit": True}'/>
                                    <field name="identification_id"/>
                                    <field name="state" invisible='1'/>
                                    <field name="beneficiario"/>
                                    <field name="fecha" required="True"/>
                                    <field name="tipo_documento" required="True"/>
                                    <field name="nro_documento" attrs="{'required': [('tipo_documento','=','Factura')]}"/>
                                    <field name="valor" required="True"/>
                                    <field name="valor_aprobado" required="True"  groups="account_payment_purchase.group_reembolso_contador, account_payment_purchase.group_reembolso_manager , base.group_no_one"/>
                                    <field name="observacion" />
                                    <field name="verificado" groups="account_payment_purchase.group_reembolso_contador, account_payment_purchase.group_reembolso_manager , base.group_no_one"/>
                                </tree>
                            </field>
                            <group>
                                <group class="oe_subtotal_footer oe_right">
                                    <field name="total"/>
                                    <field name="val_pagado" readonly="1"/>
                                    <field name="payments_widget" colspan="2" nolabel="1" widget="payment"/>
                                    <field name="residual" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Detalle de Pagos" groups="account_payment_purchase.group_reembolso_contador,account_payment_purchase.group_reembolso_manager">
                            <field name="line_pagos_ids" attrs="{'readonly': [('state','=','paid')]}">
                                <tree string="Pagos Lines" editable="bottom">
                                    <field name="payment_id"/>
                                    <field name="fecha_pago"/>
                                    <field name="diario_pago" />
                                    <field name="monto_pago"/>
                                    
                                </tree>
                            </field>
                        </page>
                        <page string="Otra Información">
                            <group col="4">
                                <field name="user_id" required="1"/>
                                <field name="company_id" widget="selection"/>
                                <field name="journal_id" invisible='1'/>
                                <field name="cuenta_reembolso" invisible='1'/>
                                <field name="move_id" invisible='1'/>
                                <field name="liquidation_move_id" readonly="1"/>
                                <!-- <field name="move_reembolso_id"/> -->
                                <field name="currency_id" invisible='1' groups="base.group_multi_currency" options='{"no_open": True, "no_quick_create": True, "no_create_edit": True}' />
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" groups="base.group_user" options="{'post_refresh': 'recipients'}"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Action for Registro de Reembolsos -->
    <record id="action_registro_reembolso" model="ir.actions.act_window">
        <field name="name">Registro de Reembolsos</field>
        <field name="res_model">hr.registro.reembolsos</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_reg_reembolso_tree"/>
        <field name="search_view_id" ref="view_reg_reembolso_filter"/>
        <field name="context">{'search_default_mis_reembolsos': 1}</field>
        <field name="target">current</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Click para crear un Registro de Reembolso.
            </p><p>
                Cuando el Registro es validado, se puede realizar el respectivo pago.
            </p>
        </field>
    </record>


<!-- 		rubros -->
    <record id="view_hr_rubros_form" model="ir.ui.view">
        <field name="name">hr.rubros.form</field>
        <field name="model">hr.rubros</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <field name="codigo"/>
                         <field name="product_id" required='1'/>
                        <field name="name"/>
                        <field name="valor"/>
                        <field name="otros"/>
                        <field name="account_debit"/>
                        <field name="account_credit"/>
                        <field name="taxes_id" options='{"always_reload": True, "no_quick_create": True, "no_create_edit": True}'/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>
    
    <record id="view_rubros_tree" model="ir.ui.view">
        <field name="name">hr.rubros.tree</field>
        <field name="model">hr.rubros</field>
        <field name="arch" type="xml">
            <tree>
                    <field name="codigo"/>
                    <field name="product_id"/>
                    <field name="name"/>
                    <field name="valor"/>
                    <field name="otros"/>
                    <field name="taxes_id"/>
            </tree>
        </field>
    </record>
        
    <record id="action_rubros_form" model="ir.actions.act_window">
        <field name="name">Rubros</field>
        <field name="res_model">hr.rubros</field>
        <field name="view_mode">tree,form</field>       
    </record>
   		
<!--    		<menuitem id="menu_reembolsos_contabilidad_root" -->
<!--                   name="Reembolsos" -->
<!--                   parent="account.menu_finance" -->
<!--                   sequence="10"/> -->
                  
<!--         <menuitem id="menu_reembolsos" -->
<!--                   name="Registro Reembolsos" -->
<!--                   parent="menu_reembolsos_contabilidad_root" -->
<!--                   sequence="0" -->
<!--                   action="action_registro_reembolso" -->
<!--                   groups="account.group_account_user"/> -->

    <menuitem
        id="menu_reembolsos_contabilidad"
        name="Reembolsos"
        parent="account.menu_finance_entries"
        sequence="25"
        groups="account_payment_purchase.group_reembolso_user"
    />


    <!-- Submenú: Registro de Reembolsos -->
    <menuitem id="menu_registro_reembolsos"
                name="Registro Reembolsos"
                parent="menu_reembolsos_contabilidad"
                sequence="0"
                action="action_registro_reembolso"
                groups="account_payment_purchase.group_reembolso_user"/>
                  
    <menuitem
        id="reembolso_menu_conf"
        name="Reembolsos"
        parent="account.menu_finance_configuration"
        sequence="55"/>
                  
    <menuitem
        id="rubros_settings"
        name="Configuracion Rubros"
        sequence="2"
        parent="reembolso_menu_conf"
        action="action_rubros_form"
        groups="account_payment_purchase.group_reembolso_manager"
    />

</odoo>
